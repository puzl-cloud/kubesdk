name: Test

on:
  pull_request:
    branches:
      - main
      - release
  push:
    branches:
      - main

jobs:
  test:
    name: Run tests
    runs-on: puzl-ubuntu-latest
    env:
      UV_SYSTEM_PYTHON: 1
      MAX_PARALLEL_DOWNLOAD: 10
    steps:
      - uses: actions/checkout@v5
      - name: Setup UV
        uses: ./.github/actions/setup-uv
      - name: Generate data models
        run: bash kube_models_generator.sh
      - name: Build
        run: uv build --all-packages
      - name: Run all package tests
        run: |
          find packages -type d -name test | while read TEST_DIR; do
            PKG=$(dirname "${TEST_DIR}")
            echo "Running tests in ${TEST_DIR} ${PKG}"
            if [ "$(basename "$PKG")" = "kube_models" ]; then
              uv run --isolated --no-project --with "${PKG}" \
                python3 -m unittest discover -v -s "${TEST_DIR}"
            else
              uv run \
                python3 -m unittest discover -v -s "${TEST_DIR}"
            fi
          done
      - name: Check if publishable (dry-run)
        run: uv publish --dry-run
